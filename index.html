<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>REad</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        :root {
            --bg-color: #f5f5f5;
            --text-color: #333333;
            --card-bg: #ffffff;
            --accent-color: #4a6fa5;
            --accent-hover: #3a5a8c;
            --border-color: #dddddd;
            --shadow: rgba(0, 0, 0, 0.1);
            --secondary-bg: #e9e9e9;
            --selected-color: #4a6fa5;
            --danger-color: #ff6b6b;
            --danger-hover: #ff5252;
            --light-accent: rgba(74, 111, 165, 0.95);
            --light-danger: rgba(255, 107, 107, 0.95);
            --panel-accent-light: #4a6fa5;
            --panel-danger-light: #ff6b6b;
            --panel-accent-dark: #2d4a7a;
            --panel-danger-dark: #cc5555;
        }
        
        body.dark-mode {
            --bg-color: #1a1a1a;
            --text-color: #f0f0f0;
            --card-bg: #2d2d2d;
            --accent-color: #6a9ae3;
            --accent-hover: #8ab4f8;
            --border-color: #444444;
            --shadow: rgba(0, 0, 0, 0.3);
            --secondary-bg: #3a3a3a;
            --selected-color: #6a9ae3;
            --danger-color: #ff6b6b;
            --danger-hover: #ff5252;
            --light-accent: rgba(106, 154, 227, 0.95);
            --light-danger: rgba(255, 107, 107, 0.95);
            --panel-accent-light: #2d4a7a;
            --panel-danger-light: #cc5555;
            --panel-accent-dark: #2d4a7a;
            --panel-danger-dark: #cc5555;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
            position: relative;
            background-color: var(--card-bg);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        /* 初始比例 9:16 */
        .app-container:not(.pc-mode) {
            max-width: 45vh; /* 9:16 比例，基于高度计算宽度 */
            max-height: 80vh;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
        }
        
        /* PC模式 16:9 - 只是UI调整，不改变比例 */
        .app-container.pc-mode {
            max-width: 90vw;
            max-height: 90vh;
            border-radius: 10px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
        }
        
        /* 强制横屏（手机端双页模式） */
        .app-container.force-landscape {
            max-width: 80vh; /* 16:9 比例 */
            max-height: 45vh;
            transform: rotate(90deg);
        }
        
        /* 旋转效果 - 新增 */
        .app-container.rotate-90 {
            transform: rotate(90deg);
            transform-origin: center center;
            width: 100vh;
            height: 100vw;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(90deg);
            max-width: 100vh !important;
            max-height: 100vw !important;
            border-radius: 10px;
        }
        
        /* 新增：180度旋转 */
        .app-container.rotate-180 {
            transform: rotate(180deg);
            transform-origin: center center;
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(180deg);
            max-width: 100vw !important;
            max-height: 100vh !important;
            border-radius: 10px;
        }
        
        .app-container.rotate-270 {
            transform: rotate(270deg);
            transform-origin: center center;
            width: 100vh;
            height: 100vw;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(270deg);
            max-width: 100vh !important;
            max-height: 100vw !important;
            border-radius: 10px;
        }
        
        /* PC模式下的旋转 */
        .app-container.pc-mode.rotate-90,
        .app-container.pc-mode.rotate-270 {
            max-width: 90vh !important;
            max-height: 90vw !important;
        }
        
        /* PC模式下的180度旋转 */
        .app-container.pc-mode.rotate-180 {
            max-width: 90vw !important;
            max-height: 90vh !important;
        }
        
        /* 头部 */
        .header {
            padding: 15px 20px;
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            flex-shrink: 0;
        }
        
        .logo {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent-color);
            letter-spacing: 1px;
        }
        
        .logo span {
            color: #ff6b6b;
        }
        
        .progress-info {
            font-size: 14px;
            opacity: 0.8;
        }
        
        /* 内容区域 - 确保一页就是一个屏幕 */
        .content-area {
            flex: 1;
            overflow: hidden;
            position: relative;
            background-color: var(--card-bg);
        }
        
        /* 无文本时的提示 */
        .no-text-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            padding: 40px;
            text-align: center;
            font-size: 18px;
            color: var(--text-color);
            opacity: 0.7;
        }
        
        .placeholder-subtitle {
            font-size: 14px;
            margin-top: 10px;
            opacity: 0.6;
        }
        
        /* 阅读器容器 */
        .reader-container {
            height: 100%;
            width: 100%;
            position: relative;
            overflow: hidden;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            -webkit-transform: translate3d(0, 0, 0);
            transform: translate3d(0, 0, 0);
        }
        
        /* 智能分页系统样式 */
        .page-container {
            height: 100%;
            width: 100%;
            position: relative;
            overflow: hidden;
        }
        
        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 25px;
            line-height: 1.6;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            opacity: 0;
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.23, 1, 0.32, 1), opacity 0.3s ease;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            -webkit-transform: translate3d(0, 0, 0);
            transform: translate3d(0, 0, 0);
        }
        
        /* 优化：为动画页面添加硬件加速 */
        .page.animating {
            -webkit-transform: translate3d(0, 0, 0);
            transform: translate3d(0, 0, 0);
        }
        
        .page.active {
            opacity: 1;
            transform: translateX(0);
        }
        
        .page-content {
            flex: 1;
            overflow: hidden;
            word-wrap: break-word;
            overflow-wrap: break-word;
            transition: font-size 0.4s ease;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
        }
        
        .page-content p {
            margin-bottom: 1em;
            text-align: justify;
            word-break: break-word;
            overflow-wrap: break-word;
        }
        
        .page-content p:last-child {
            margin-bottom: 0;
        }
        
        /* 滚动模式 */
        .scroll-mode-container {
            height: 100%;
            overflow-y: auto;
            padding: 20px;
            line-height: 1.6;
            position: relative;
            transition: font-size 0.4s ease;
        }
        
        .scroll-mode-container .content {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .scroll-mode-container p {
            margin-bottom: 1em;
            text-align: justify;
        }
        
        /* 双页模式 */
        .double-page-container {
            height: 100%;
            width: 100%;
            display: flex;
            overflow: hidden;
        }
        
        .double-page {
            flex: 1;
            height: 100%;
            padding: 25px;
            line-height: 1.6;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .page-separator {
            width: 1px;
            background-color: var(--border-color);
            margin: 10px 0;
        }
        
        /* 页码和导航 - 缩小版本 */
        .page-navigation {
            padding: 8px 15px;
            background-color: var(--card-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            flex-shrink: 0;
            height: 50px;
        }
        
        .nav-button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
            min-width: 70px;
        }
        
        .nav-button:hover {
            background-color: var(--accent-hover);
        }
        
        .nav-button:disabled {
            background-color: #aaaaaa;
            cursor: not-allowed;
        }
        
        .page-indicator {
            font-size: 14px;
            opacity: 0.8;
        }
        
        /* 设置按钮 - 添加动画状态 - 现在在body中固定位置 */
        .settings-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 4px 12px var(--shadow);
            transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            transform-origin: center;
            overflow: hidden;
        }
        
        .settings-button:hover {
            background-color: var(--accent-hover);
        }
        
        /* 设置按钮动画状态 */
        .settings-button.animating {
            transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
        }
        
        .settings-button.rotating i {
            animation: rotateAndFade 0.7s cubic-bezier(0.23, 1, 0.32, 1) forwards;
        }
        
        .settings-button.expanding {
            border-radius: 10px 10px 0 0;
            width: 320px;
            height: 60px;
            background-color: var(--card-bg);
            align-items: flex-start;
            padding: 15px;
            justify-content: flex-start;
            box-shadow: 0 -5px 25px var(--shadow);
            border: 1px solid var(--border-color);
            border-bottom: none;
            color: var(--text-color);
            right: 20px !important; /* 确保动画期间位置固定 */
            bottom: 20px !important; /* 确保动画期间位置固定 */
        }
        
        .settings-button.expanding i {
            opacity: 0;
        }
        
        /* 初始化按钮 - 现在在body中固定位置 */
        .initial-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 4px 12px var(--shadow);
            transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            transform-origin: center;
            overflow: hidden;
        }
        
        .initial-button:hover {
            background-color: var(--danger-hover);
        }
        
        /* 初始化按钮动画状态 */
        .initial-button.animating {
            transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
        }
        
        .initial-button.rotating i {
            animation: rotateAndFade 0.7s cubic-bezier(0.23, 1, 0.32, 1) forwards;
        }
        
        .initial-button.expanding {
            border-radius: 10px 10px 0 0;
            width: 320px;
            height: 60px;
            background-color: var(--card-bg);
            align-items: flex-start;
            padding: 15px;
            justify-content: flex-start;
            box-shadow: 0 -5px 25px var(--shadow);
            border: 1px solid var(--border-color);
            border-bottom: none;
            color: var(--text-color);
            left: 20px !important; /* 确保动画期间位置固定 */
            bottom: 20px !important; /* 确保动画期间位置固定 */
        }
        
        .initial-button.expanding i {
            opacity: 0;
        }
        
        @keyframes rotateAndFade {
            0% {
                transform: rotate(0deg) scale(1);
                opacity: 1;
            }
            30% {
                transform: rotate(90deg) scale(1.1);
                opacity: 0.8;
            }
            60% {
                transform: rotate(180deg) scale(1);
                opacity: 0.6;
            }
            80% {
                transform: rotate(270deg) scale(0.9);
                opacity: 0.3;
            }
            100% {
                transform: rotate(360deg) scale(0.8);
                opacity: 0;
            }
        }
        
        /* 设置面板 - 从按钮向上延伸 */
        .settings-panel {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 320px;
            background-color: var(--card-bg);
            border-radius: 10px 10px 0 0;
            box-shadow: 0 -5px 25px var(--shadow);
            z-index: 99;
            padding: 20px;
            display: none;
            border: 1px solid var(--border-color);
            border-bottom: none;
            max-height: 80vh;
            overflow-y: auto;
            opacity: 0;
            transform: translateY(100%);
            transform-origin: bottom;
            transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
        }
        
        .settings-panel.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        
        /* 设置面板内容动画 */
        .settings-panel .settings-title,
        .settings-panel .settings-group {
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s ease;
        }
        
        .settings-panel.show .settings-title {
            opacity: 1;
            transform: translateY(0);
            transition-delay: 0.2s;
        }
        
        .settings-panel.show .settings-group {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* 设置组延迟动画 */
        .settings-panel.show .settings-group:nth-child(1) { transition-delay: 0.25s; }
        .settings-panel.show .settings-group:nth-child(2) { transition-delay: 0.3s; }
        .settings-panel.show .settings-group:nth-child(3) { transition-delay: 0.35s; }
        .settings-panel.show .settings-group:nth-child(4) { transition-delay: 0.4s; }
        .settings-panel.show .settings-group:nth-child(5) { transition-delay: 0.45s; }
        .settings-panel.show .settings-group:nth-child(6) { transition-delay: 0.5s; }
        .settings-panel.show .settings-group:nth-child(7) { transition-delay: 0.55s; }
        .settings-panel.show .settings-group:nth-child(8) { transition-delay: 0.6s; }
        
        .settings-title {
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .settings-group {
            margin-bottom: 20px;
        }
        
        .settings-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        /* 文件导入按钮样式 */
        .file-input-container {
            width: 100%;
            margin-top: 5px;
        }
        
        .file-input-label {
            display: block;
            background-color: var(--accent-color);
            color: white;
            padding: 12px 20px;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .file-input-label:hover {
            background-color: var(--accent-hover);
        }
        
        #file-input {
            display: none;
        }
        
        .file-name {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 5px;
            text-align: center;
            word-break: break-all;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--accent-color);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .settings-select {
            width: 100%;
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 16px;
        }
        
        .font-size-control {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .font-size-value {
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }
        
        .font-size-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .font-size-btn:hover {
            background-color: var(--accent-hover);
        }
        
        .history-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            color: var(--text-color);
            cursor: pointer;
            font-size: 16px;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .history-btn:hover {
            background-color: var(--accent-color);
            color: white;
        }
        
        /* 旋转控制样式 - 现在放在历史记录按钮下面 */
        .rotation-control {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .rotation-buttons {
            display: flex;
            gap: 10px;
        }
        
        .rotation-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--accent-color);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
        }
        
        .rotation-btn:hover {
            background-color: var(--accent-hover);
            transform: scale(1.05);
        }
        
        .rotation-value {
            font-weight: bold;
            min-width: 60px;
            text-align: center;
            font-size: 16px;
        }
        
        .reset-rotation-btn {
            padding: 8px 12px;
            background-color: var(--secondary-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .reset-rotation-btn:hover {
            background-color: var(--accent-color);
            color: white;
        }
        
        /* 初始化确认面板 - 从按钮向上延伸 */
        .initial-confirm-panel {
            position: fixed;
            bottom: 80px;
            left: 20px;
            width: 320px;
            background-color: var(--card-bg);
            border-radius: 10px 10px 0 0;
            box-shadow: 0 -5px 25px var(--shadow);
            z-index: 99;
            padding: 20px;
            display: none;
            border: 1px solid var(--border-color);
            border-bottom: none;
            max-height: 80vh;
            overflow-y: auto;
            opacity: 0;
            transform: translateY(100%);
            transform-origin: bottom;
            transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
        }
        
        .initial-confirm-panel.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        
        .initial-confirm-title {
            font-size: 20px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .initial-confirm-message {
            margin-bottom: 20px;
            line-height: 1.5;
            color: var(--text-color);
        }
        
        .initial-confirm-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* 历史记录面板 - 从底部弹出 */
        .history-panel {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) translateY(100%);
            width: 100%;
            max-width: 800px;
            max-height: 85vh; /* 增高历史记录面板 */
            background-color: var(--card-bg);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -10px 40px var(--shadow);
            z-index: 200;
            padding: 25px;
            display: none;
            flex-direction: column;
            border: 1px solid var(--border-color);
            border-bottom: none;
            transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            overflow: hidden;
        }
        
        .history-panel.show {
            display: flex;
            transform: translateX(-50%) translateY(0);
        }
        
        /* 历史记录面板内容区域 */
        .history-content {
            display: flex;
            flex-direction: column;
            height: 100%;
            transition: all 0.4s ease;
        }
        
        /* 删除确认模式下的历史记录面板 */
        .history-panel.delete-confirm-mode {
            max-height: 300px;
            transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
        }
        
        .history-panel.delete-confirm-mode .history-content {
            opacity: 0;
            transform: translateY(-20px);
            height: 0;
            overflow: hidden;
        }
        
        .history-panel.delete-confirm-mode .delete-confirm-content {
            opacity: 1;
            transform: translateY(0);
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        /* 删除确认内容 */
        .delete-confirm-content {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            flex-direction: column;
            height: 100%;
            justify-content: center;
            transition: all 0.4s ease 0.2s;
        }
        
        .delete-confirm-title {
            font-size: 22px;
            margin-bottom: 20px;
            color: var(--text-color);
            text-align: center;
        }
        
        .delete-confirm-message {
            margin-bottom: 30px;
            line-height: 1.5;
            color: var(--text-color);
            text-align: center;
            font-size: 16px;
        }
        
        .delete-confirm-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .history-title {
            font-size: 24px;
            font-weight: 600;
        }
        
        .close-history {
            background: none;
            border: none;
            font-size: 28px;
            color: var(--text-color);
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        
        .close-history:hover {
            background-color: var(--secondary-bg);
        }
        
        .history-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            max-height: calc(85vh - 200px);
        }
        
        .history-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .history-item:hover {
            background-color: var(--secondary-bg);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        /* 改进的高亮效果 */
        .history-item.selected {
            background-color: rgba(74, 111, 165, 0.15);
            border-left: 4px solid var(--selected-color);
        }
        
        .history-item.selected .history-filename {
            color: var(--selected-color);
            font-weight: 600;
        }
        
        .history-filename {
            flex: 1;
            font-weight: 500;
            transition: color 0.2s;
            font-size: 16px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 15px;
        }
        
        .history-date {
            font-size: 14px;
            opacity: 0.7;
            margin-left: 10px;
            white-space: nowrap;
        }
        
        .history-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid var(--accent-color);
            border-radius: 4px;
            margin-right: 15px;
            display: none;
            flex-shrink: 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .history-checkbox:hover {
            border-color: var(--accent-hover);
        }
        
        .history-checkbox.checked {
            background-color: var(--accent-color);
            position: relative;
        }
        
        .history-checkbox.checked:after {
            content: "✓";
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            font-weight: bold;
        }
        
        .history-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-color);
            opacity: 0.6;
            font-size: 18px;
        }
        
        .history-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .delete-selected-btn, .delete-all-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .delete-selected-btn {
            background-color: var(--danger-color);
            color: white;
        }
        
        .delete-selected-btn:hover {
            background-color: var(--danger-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }
        
        .delete-selected-btn:disabled {
            background-color: #aaaaaa;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .delete-all-btn {
            background-color: var(--secondary-bg);
            color: var(--text-color);
        }
        
        .delete-all-btn:hover {
            background-color: var(--danger-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }
        
        .manage-history-btn {
            padding: 10px 20px;
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-color);
            cursor: pointer;
            font-size: 15px;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .manage-history-btn:hover {
            background-color: var(--accent-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 111, 165, 0.3);
        }
        
        /* 模态框 - 现在只用于文件不存在确认 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000; /* 提高z-index使其前置显示 */
            display: none;
            justify-content: center;
            align-items: center;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal {
            background-color: var(--card-bg);
            border-radius: 10px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1001; /* 确保模态框在遮罩层之上 */
        }
        
        .modal-title {
            font-size: 20px;
            margin-bottom: 15px;
            color: var(--text-color);
        }
        
        .modal-message {
            margin-bottom: 20px;
            line-height: 1.5;
            color: var(--text-color);
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .modal-btn {
            padding: 8px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }
        
        .modal-btn.confirm {
            background-color: var(--accent-color);
            color: white;
        }
        
        .modal-btn.confirm:hover {
            background-color: var(--accent-hover);
            transform: scale(1.05);
        }
        
        .modal-btn.cancel {
            background-color: var(--secondary-bg);
            color: var(--text-color);
        }
        
        .modal-btn.cancel:hover {
            background-color: #cccccc;
            transform: scale(1.05);
        }
        
        /* 初始化确认按钮 */
        .modal-btn.reset {
            background-color: var(--danger-color);
            color: white;
        }
        
        .modal-btn.reset:hover {
            background-color: var(--danger-hover);
            transform: scale(1.05);
        }
        
        /* 触控提示 - 现在在body中固定位置 */
        .touch-hint {
            position: fixed;
            bottom: 85px; /* 在设置按钮上方 */
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 10px 15px;
            font-size: 14px;
            z-index: 50;
            display: none;
            box-shadow: 0 3px 10px var(--shadow);
            text-align: center;
            white-space: nowrap;
        }
        
        .touch-hint.show {
            display: block;
        }
        
        /* 新增：面板融合效果 */
        .panel-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .panel-header i {
            font-size: 20px;
        }
        
        /* 设置面板的图标和标题样式 */
        .settings-panel .panel-header i {
            color: var(--accent-color);
        }
        
        /* 初始化确认面板的图标和标题样式 */
        .initial-confirm-panel .panel-header i {
            color: var(--danger-color);
        }
        
        /* 响应式调整 */
        @media (min-width: 768px) {
            .app-container:not(.pc-mode) {
                max-width: 45vh;
                max-height: 80vh;
            }
            
            .app-container.pc-mode {
                max-width: 90vw;
                max-height: 90vh;
            }
        }
        
        /* 手机端双页模式强制横屏 */
        @media (max-width: 768px) {
            .app-container.double-mode:not(.pc-mode) {
                max-width: 80vh;
                max-height: 45vh;
                transform: rotate(90deg);
            }
            
            /* 移动端按钮调整 */
            .settings-button, .initial-button {
                width: 45px;
                height: 45px;
                font-size: 20px;
            }
            
            .settings-button.expanding, .initial-button.expanding {
                width: 90vw;
                right: 5vw !important;
                left: auto !important;
            }
            
            .initial-button.expanding {
                left: 5vw !important;
                right: auto !important;
            }
            
            .settings-panel, .initial-confirm-panel {
                width: 90vw;
                right: 5vw;
                left: auto;
            }
            
            .initial-confirm-panel {
                left: 5vw;
                right: auto;
            }
            
            .history-panel {
                width: 100%;
                max-width: 100%;
                border-radius: 20px 20px 0 0;
                padding: 20px;
            }
            
            .history-title {
                font-size: 20px;
            }
            
            .history-filename {
                font-size: 14px;
            }
            
            .history-date {
                font-size: 12px;
            }
            
            .rotation-control {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .rotation-buttons {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--secondary-bg);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-hover);
        }
        
        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes slideDown {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(100%); opacity: 0; }
        }
        
        .fade-in {
            animation: fadeIn 0.4s ease;
        }
        
        .slide-in {
            animation: slideIn 0.4s ease;
        }
        
        /* 加载动画 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: var(--accent-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="light-mode">
    <div class="app-container" id="app-container">
        <div class="header">
            <div class="logo">R<span>E</span>ad</div>
            <div class="progress-info" id="progress-info">等待导入文本</div>
        </div>
        
        <div class="content-area" id="content-area">
            <div class="no-text-placeholder" id="no-text-placeholder">
                REad System 需要你导入TXT文本文档
                <div class="placeholder-subtitle">请在右下角设置中导入</div>
            </div>
            
            <div class="reader-container" id="reader-container" style="display: none;">
                <!-- 内容将通过JavaScript动态生成 -->
            </div>
        </div>
        
        <div class="page-navigation" id="page-navigation" style="display: none;">
            <button class="nav-button" id="prev-page">上一页</button>
            <div class="page-indicator" id="page-indicator">第 <span id="current-page">1</span> 页 / 共 <span id="total-pages">1</span> 页</div>
            <button class="nav-button" id="next-page">下一页</button>
        </div>
        
        <!-- 触控提示 - 保持在app-container内，因为它指示的是阅读器内部操作 -->
        <div class="touch-hint" id="touch-hint">
            提示：左右滑动翻页
        </div>
    </div>
    
    <!-- 设置按钮 - 移到body中，固定在视口右下角 -->
    <div class="settings-button" id="settings-button">
        <i class="fas fa-cog"></i>
    </div>
    
    <!-- 初始化按钮 - 移到body中，固定在视口左下角 -->
    <div class="initial-button" id="initial-button">
        <i class="fas fa-times"></i>
    </div>
    
    <!-- 设置面板 - 移到body中，不随容器旋转 -->
    <div class="settings-panel" id="settings-panel">
        <div class="panel-header">
            <i class="fas fa-cog"></i>
            <span>阅读设置</span>
        </div>
        
        <!-- 文件导入功能 -->
        <div class="settings-group">
            <label class="settings-label">导入TXT文档</label>
            <div class="file-input-container">
                <label for="file-input" class="file-input-label">
                    <i class="fas fa-file-import"></i> 选择TXT文件
                </label>
                <input type="file" id="file-input" accept=".txt">
                <div class="file-name" id="file-name">未选择文件</div>
            </div>
        </div>
        
        <div class="settings-group">
            <label class="settings-label">PC模式 (16:9)</label>
            <label class="toggle-switch">
                <input type="checkbox" id="pc-mode-toggle">
                <span class="toggle-slider"></span>
            </label>
        </div>
        
        <div class="settings-group">
            <label class="settings-label">阅读模式</label>
            <select class="settings-select" id="reading-mode">
                <option value="single">单页模式</option>
                <option value="double">双页模式</option>
                <option value="scroll">滚动模式</option>
            </select>
        </div>
        
        <div class="settings-group">
            <label class="settings-label">主题模式</label>
            <label class="toggle-switch">
                <input type="checkbox" id="dark-mode-toggle">
                <span class="toggle-slider"></span>
                <span style="margin-left: 60px;">暗色模式</span>
            </label>
        </div>
        
        <div class="settings-group">
            <label class="settings-label">字体大小</label>
            <div class="font-size-control">
                <button class="font-size-btn" id="font-decrease">-</button>
                <div class="font-size-value" id="font-size-value">3</div>
                <button class="font-size-btn" id="font-increase">+</button>
            </div>
        </div>
        
        <!-- 历史记录按钮 - 现在在旋转控制上面 -->
        <div class="settings-group">
            <button class="history-btn" id="history-btn">
                <span>历史记录</span>
                <i class="fas fa-history"></i>
            </button>
        </div>
        
        <!-- 旋转控制 - 移动到设置面板最底部（历史记录按钮下面） -->
        <div class="settings-group">
            <label class="settings-label">旋转阅读区域</label>
            <div class="rotation-control">
                <div class="rotation-buttons">
                    <button class="rotation-btn" id="rotate-ccw" title="逆时针旋转90度">
                        <i class="fas fa-undo"></i>
                    </button>
                    <div class="rotation-value" id="rotation-value">0°</div>
                    <button class="rotation-btn" id="rotate-cw" title="顺时针旋转90度">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
                <button class="reset-rotation-btn" id="reset-rotation">重置</button>
            </div>
        </div>
    </div>
    
    <!-- 初始化确认面板 - 移到body中，不随容器旋转 -->
    <div class="initial-confirm-panel" id="initial-confirm-panel">
        <div class="panel-header">
            <i class="fas fa-times"></i>
            <span>初始化确认</span>
        </div>
        <p class="initial-confirm-message">是否要对REad进行初始化？初始化将重置所有设置到默认状态：关闭PC模式、切换到单页模式、启用亮色主题、重置旋转角度。</p>
        <div class="initial-confirm-actions">
            <button class="modal-btn cancel" id="cancel-initial">取消</button>
            <button class="modal-btn reset" id="confirm-initial">初始化</button>
        </div>
    </div>
    
    <!-- 历史记录面板 - 移到body中，不随容器旋转 -->
    <div class="history-panel" id="history-panel">
        <!-- 历史记录内容区域 -->
        <div class="history-content">
            <div class="history-header">
                <h3 class="history-title">历史记录</h3>
                <button class="close-history" id="close-history">&times;</button>
            </div>
            
            <div class="history-list" id="history-list">
                <!-- 历史记录将动态生成 -->
            </div>
            
            <div class="history-footer">
                <button class="delete-all-btn" id="delete-all-btn" style="display: none;">全部删除</button>
                <button class="delete-selected-btn" id="delete-selected-btn" style="display: none;" disabled>删除选中</button>
                <button class="manage-history-btn" id="manage-history-btn">管理</button>
            </div>
        </div>
        
        <!-- 删除确认内容（默认隐藏） -->
        <div class="delete-confirm-content" id="delete-confirm-content">
            <h3 class="delete-confirm-title" id="delete-confirm-title">确认删除</h3>
            <p class="delete-confirm-message" id="delete-confirm-message"></p>
            <div class="delete-confirm-actions">
                <button class="modal-btn cancel" id="cancel-delete">取消</button>
                <button class="modal-btn confirm" id="confirm-delete">删除</button>
            </div>
        </div>
    </div>
    
    <!-- 文件不存在确认模态框 -->
    <div class="modal-overlay" id="file-missing-modal">
        <div class="modal">
            <h3 class="modal-title">文件不存在</h3>
            <p class="modal-message" id="file-missing-message"></p>
            <div class="modal-actions">
                <button class="modal-btn cancel" id="keep-history">保留记录</button>
                <button class="modal-btn confirm" id="delete-history">删除记录</button>
            </div>
        </div>
    </div>
</body>
</html>

<script>
        // 应用状态
        const state = {
            textContent: '',
            pages: [],
            currentPage: 1,
            totalPages: 1,
            fileName: '',
            fontSize: 3, // 1-10级别
            isDarkMode: false,
            isPcMode: false,
            readingMode: 'single', // scroll, single, double
            isManagingHistory: false,
            selectedHistoryItems: [],
            isAnimating: false, // 防止动画期间重复触发
            isLoading: false, // 防止重复加载
            rotationAngle: 0 // 新增：旋转角度 (0, 90, 180, 270)
        };

        // 本地存储键名
        const STORAGE_KEYS = {
            SETTINGS: 'read_settings',
            HISTORY: 'read_history',
            LAST_FILE: 'read_last_file',
            LAST_FILENAME: 'read_last_filename',
            LAST_POSITION: 'read_last_position'
        };

        // DOM元素
        const appContainer = document.getElementById('app-container');
        const contentArea = document.getElementById('content-area');
        const noTextPlaceholder = document.getElementById('no-text-placeholder');
        const readerContainer = document.getElementById('reader-container');
        const pageNavigation = document.getElementById('page-navigation');
        const progressInfo = document.getElementById('progress-info');
        const fileInput = document.getElementById('file-input');
        const fileNameDisplay = document.getElementById('file-name');
        const settingsButton = document.getElementById('settings-button');
        const settingsPanel = document.getElementById('settings-panel');
        const initialButton = document.getElementById('initial-button');
        const initialConfirmPanel = document.getElementById('initial-confirm-panel');
        const pcModeToggle = document.getElementById('pc-mode-toggle');
        const readingModeSelect = document.getElementById('reading-mode');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const fontDecreaseBtn = document.getElementById('font-decrease');
        const fontIncreaseBtn = document.getElementById('font-increase');
        const fontSizeValue = document.getElementById('font-size-value');
        const prevPageBtn = document.getElementById('prev-page');
        const nextPageBtn = document.getElementById('next-page');
        const currentPageSpan = document.getElementById('current-page');
        const totalPagesSpan = document.getElementById('total-pages');
        const historyBtn = document.getElementById('history-btn');
        const historyPanel = document.getElementById('history-panel');
        const historyList = document.getElementById('history-list');
        const closeHistoryBtn = document.getElementById('close-history');
        const manageHistoryBtn = document.getElementById('manage-history-btn');
        const deleteAllBtn = document.getElementById('delete-all-btn');
        const deleteSelectedBtn = document.getElementById('delete-selected-btn');
        const touchHint = document.getElementById('touch-hint');
        const fileMissingModal = document.getElementById('file-missing-modal');
        const fileMissingMessage = document.getElementById('file-missing-message');
        const keepHistoryBtn = document.getElementById('keep-history');
        const deleteHistoryBtn = document.getElementById('delete-history');
        const cancelInitialBtn = document.getElementById('cancel-initial');
        const confirmInitialBtn = document.getElementById('confirm-initial');
        const deleteConfirmContent = document.getElementById('delete-confirm-content');
        const deleteConfirmTitle = document.getElementById('delete-confirm-title');
        const deleteConfirmMessage = document.getElementById('delete-confirm-message');
        const cancelDeleteBtn = document.getElementById('cancel-delete');
        const confirmDeleteBtn = document.getElementById('confirm-delete');
        
        // 新增：旋转相关DOM元素
        const rotateCcwBtn = document.getElementById('rotate-ccw');
        const rotateCwBtn = document.getElementById('rotate-cw');
        const resetRotationBtn = document.getElementById('reset-rotation');
        const rotationValue = document.getElementById('rotation-value');

        // 字体大小映射 (级别 -> 像素)
        const fontSizeMap = {
            1: 14, 2: 16, 3: 18, 4: 20, 5: 22, 
            6: 24, 7: 26, 8: 28, 9: 30, 10: 32
        };

        // 当前尝试打开的历史记录项
        let currentHistoryItem = null;
        // 删除操作的回调函数
        let deleteCallback = null;
        // 动画状态
        let isSettingsAnimating = false;
        let isInitialAnimating = false;
        let isHistoryPanelOpen = false;

        // 初始化应用
        function initApp() {
            // 从本地存储加载设置
            loadSettings();
            
            // 绑定事件监听器
            bindEvents();
            
            // 更新UI
            updateUI();
            
            // 检查是否有上次的文件
            loadLastFile();
            
            // 显示触控提示（仅移动设备）
            if (isMobileDevice()) {
                setTimeout(() => {
                    touchHint.classList.add('show');
                    setTimeout(() => touchHint.classList.remove('show'), 3000);
                }, 1000);
            }
            
            // 应用初始旋转
            applyRotation();
        }

        // 绑定事件
        function bindEvents() {
            // 文件导入
            fileInput.addEventListener('change', handleFileImport);
            
            // 设置按钮
            settingsButton.addEventListener('click', toggleSettingsPanel);
            
            // 初始化按钮
            initialButton.addEventListener('click', showInitialConfirmPanel);
            cancelInitialBtn.addEventListener('click', hideInitialConfirmPanel);
            confirmInitialBtn.addEventListener('click', resetToInitialSettings);
            
            // 设置切换
            pcModeToggle.addEventListener('change', togglePcMode);
            readingModeSelect.addEventListener('change', changeReadingMode);
            darkModeToggle.addEventListener('change', toggleDarkMode);
            
            // 字体大小调整
            fontDecreaseBtn.addEventListener('click', () => adjustFontSize(-1));
            fontIncreaseBtn.addEventListener('click', () => adjustFontSize(1));
            
            // 旋转控制
            rotateCcwBtn.addEventListener('click', () => rotateContent(-90));
            rotateCwBtn.addEventListener('click', () => rotateContent(90));
            resetRotationBtn.addEventListener('click', resetRotation);
            
            // 页面导航
            prevPageBtn.addEventListener('click', goToPrevPage);
            nextPageBtn.addEventListener('click', goToNextPage);
            
            // 历史记录
            historyBtn.addEventListener('click', showHistoryPanel);
            closeHistoryBtn.addEventListener('click', hideHistoryPanel);
            manageHistoryBtn.addEventListener('click', toggleManageHistory);
            deleteAllBtn.addEventListener('click', confirmDeleteAll);
            deleteSelectedBtn.addEventListener('click', confirmDeleteSelected);
            cancelDeleteBtn.addEventListener('click', cancelDeleteConfirm);
            confirmDeleteBtn.addEventListener('click', executeDelete);
            
            // 模态框
            keepHistoryBtn.addEventListener('click', () => {
                fileMissingModal.classList.remove('show');
                currentHistoryItem = null;
            });
            
            deleteHistoryBtn.addEventListener('click', () => {
                if (currentHistoryItem) {
                    deleteHistoryItem(currentHistoryItem.id);
                    fileMissingModal.classList.remove('show');
                    currentHistoryItem = null;
                }
            });
            
            // 触控滑动
            let touchStartX = 0;
            let touchStartY = 0;
            
            readerContainer.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            }, { passive: true });
            
            readerContainer.addEventListener('touchend', (e) => {
                if (state.readingMode === 'scroll') return; // 滚动模式不需要滑动翻页
                
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                
                const diffX = touchStartX - touchEndX;
                const diffY = touchStartY - touchEndY;
                
                // 水平滑动（翻页）- 仅在非滚动模式下
                if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 30) {
                    if (diffX > 0) {
                        goToNextPage();
                    } else {
                        goToPrevPage();
                    }
                    e.preventDefault();
                }
            });
            
            // 键盘控制
            document.addEventListener('keydown', handleKeyDown);
            
            // 滚动模式进度更新
            readerContainer.addEventListener('scroll', handleScroll);
            
            // 点击外部关闭面板
            document.addEventListener('click', (e) => {
                // 关闭设置面板
                if (!settingsPanel.contains(e.target) && !settingsButton.contains(e.target)) {
                    if (settingsPanel.classList.contains('show')) {
                        hideSettingsPanel();
                    }
                }
                
                // 关闭初始化确认面板
                if (!initialConfirmPanel.contains(e.target) && !initialButton.contains(e.target)) {
                    if (initialConfirmPanel.classList.contains('show')) {
                        hideInitialConfirmPanel();
                    }
                }
                
                // 关闭历史记录面板
                if (!historyPanel.contains(e.target) && !historyBtn.contains(e.target) && 
                    !fileMissingModal.contains(e.target)) {
                    if (historyPanel.classList.contains('show')) {
                        hideHistoryPanel();
                    }
                }
            });
            
            // 窗口大小变化时重新分页
            window.addEventListener('resize', debounce(() => {
                if (state.textContent && !state.isAnimating) {
                    state.isAnimating = true;
                    paginateText();
                    renderContent();
                    setTimeout(() => { state.isAnimating = false; }, 400);
                }
            }, 250));
        }

        // 显示设置面板（带动画）- 改进版
        function showSettingsPanel() {
            if (isSettingsAnimating || settingsPanel.classList.contains('show')) return;
            
            isSettingsAnimating = true;
            
            // 先隐藏其他面板
            hideInitialConfirmPanel();
            hideHistoryPanel();
            
            // 第一步：旋转图标并渐隐
            settingsButton.classList.add('animating', 'rotating');
            
            // 保存原始颜色
            const originalBgColor = settingsButton.style.backgroundColor;
            const originalColor = settingsButton.style.color;
            
            setTimeout(() => {
                // 第二步：按钮变形（变长变方）并改变颜色
                settingsButton.classList.add('expanding');
                settingsButton.classList.remove('rotating');
                
                // 按钮颜色与面板背景融合
                settingsButton.style.backgroundColor = getComputedStyle(settingsPanel).backgroundColor;
                settingsButton.style.color = getComputedStyle(settingsPanel).color;
                settingsButton.style.border = '1px solid var(--border-color)';
                settingsButton.style.borderBottom = 'none';
                
                // 确保按钮在动画期间位置固定
                settingsButton.style.right = '20px';
                settingsButton.style.bottom = '20px';
                
                setTimeout(() => {
                    // 第三步：向上延伸显示设置面板
                    settingsPanel.style.display = 'block';
                    // 强制重排以触发动画
                    settingsPanel.offsetHeight;
                    settingsPanel.classList.add('show');
                    
                    // 动画完成后重置状态
                    setTimeout(() => {
                        isSettingsAnimating = false;
                        settingsButton.classList.remove('animating');
                    }, 500);
                }, 300);
            }, 700); // 旋转动画时间
        }
        
        // 隐藏设置面板（带动画）- 改进版
        function hideSettingsPanel() {
            if (isSettingsAnimating || !settingsPanel.classList.contains('show')) return;
            
            isSettingsAnimating = true;
            
            // 第一步：隐藏设置面板
            settingsPanel.classList.remove('show');
            
            setTimeout(() => {
                // 第二步：按钮恢复圆形并显示图标
                settingsPanel.style.display = 'none';
                settingsButton.classList.remove('expanding');
                
                // 恢复按钮颜色和边框
                settingsButton.style.backgroundColor = '';
                settingsButton.style.color = '';
                settingsButton.style.border = '';
                settingsButton.style.borderBottom = '';
                settingsButton.style.right = '';
                settingsButton.style.bottom = '';
                
                // 第三步：图标重新显示
                const icon = settingsButton.querySelector('i');
                icon.style.opacity = '0';
                
                setTimeout(() => {
                    icon.style.opacity = '1';
                    icon.style.transition = 'opacity 0.3s ease';
                    
                    setTimeout(() => {
                        icon.style.transition = '';
                        isSettingsAnimating = false;
                        settingsButton.classList.remove('animating');
                    }, 300);
                }, 50);
            }, 300); // 面板隐藏动画时间
        }
        
        // 切换设置面板
        function toggleSettingsPanel() {
            if (settingsPanel.classList.contains('show')) {
                hideSettingsPanel();
            } else {
                showSettingsPanel();
            }
        }
        
        // 显示初始化确认面板（带动画）- 改进版
        function showInitialConfirmPanel() {
            if (isInitialAnimating || initialConfirmPanel.classList.contains('show')) return;
            
            isInitialAnimating = true;
            
            // 先隐藏其他面板
            hideSettingsPanel();
            hideHistoryPanel();
            
            // 第一步：旋转图标并渐隐
            initialButton.classList.add('animating', 'rotating');
            
            setTimeout(() => {
                // 第二步：按钮变形（变长变方）并改变颜色
                initialButton.classList.add('expanding');
                initialButton.classList.remove('rotating');
                
                // 按钮颜色与面板背景融合
                initialButton.style.backgroundColor = getComputedStyle(initialConfirmPanel).backgroundColor;
                initialButton.style.color = getComputedStyle(initialConfirmPanel).color;
                initialButton.style.border = '1px solid var(--border-color)';
                initialButton.style.borderBottom = 'none';
                
                // 确保按钮在动画期间位置固定
                initialButton.style.left = '20px';
                initialButton.style.bottom = '20px';
                
                setTimeout(() => {
                    // 第三步：向上延伸显示初始化确认面板
                    initialConfirmPanel.style.display = 'block';
                    // 强制重排以触发动画
                    initialConfirmPanel.offsetHeight;
                    initialConfirmPanel.classList.add('show');
                    
                    // 动画完成后重置状态
                    setTimeout(() => {
                        isInitialAnimating = false;
                        initialButton.classList.remove('animating');
                    }, 500);
                }, 300);
            }, 700); // 旋转动画时间
        }
        
        // 隐藏初始化确认面板（带动画）- 改进版
        function hideInitialConfirmPanel() {
            if (isInitialAnimating || !initialConfirmPanel.classList.contains('show')) return;
            
            isInitialAnimating = true;
            
            // 第一步：隐藏初始化确认面板
            initialConfirmPanel.classList.remove('show');
            
            setTimeout(() => {
                // 第二步：按钮恢复圆形并显示图标
                initialConfirmPanel.style.display = 'none';
                initialButton.classList.remove('expanding');
                
                // 恢复按钮颜色和边框
                initialButton.style.backgroundColor = '';
                initialButton.style.color = '';
                initialButton.style.border = '';
                initialButton.style.borderBottom = '';
                initialButton.style.left = '';
                initialButton.style.bottom = '';
                
                // 第三步：图标重新显示
                const icon = initialButton.querySelector('i');
                icon.style.opacity = '0';
                
                setTimeout(() => {
                    icon.style.opacity = '1';
                    icon.style.transition = 'opacity 0.3s ease';
                    
                    setTimeout(() => {
                        icon.style.transition = '';
                        isInitialAnimating = false;
                        initialButton.classList.remove('animating');
                    }, 300);
                }, 50);
            }, 300); // 面板隐藏动画时间
        }
        
        // 旋转阅读内容 - 改为整体容器旋转
        function rotateContent(angle) {
            if (state.isAnimating) return;
            
            state.isAnimating = true;
            
            // 计算新的旋转角度
            let newAngle = state.rotationAngle + angle;
            
            // 确保角度在0-360度之间
            if (newAngle < 0) newAngle = 360 + newAngle;
            if (newAngle >= 360) newAngle = newAngle % 360;
            
            state.rotationAngle = newAngle;
            
            // 更新UI
            updateRotationUI();
            
            // 应用旋转效果到整个app-container
            applyRotation();
            
            // 重新分页和渲染（因为旋转后尺寸变化）
            if (state.textContent) {
                setTimeout(() => {
                    paginateText();
                    renderContent();
                    
                    setTimeout(() => {
                        state.isAnimating = false;
                    }, 400);
                }, 300);
            } else {
                setTimeout(() => {
                    state.isAnimating = false;
                }, 300);
            }
            
            // 保存设置
            saveSettings();
        }
        
        // 重置旋转
        function resetRotation() {
            if (state.isAnimating || state.rotationAngle === 0) return;
            
            state.isAnimating = true;
            state.rotationAngle = 0;
            
            // 更新UI
            updateRotationUI();
            
            // 应用旋转效果
            applyRotation();
            
            // 重新分页和渲染
            if (state.textContent) {
                setTimeout(() => {
                    paginateText();
                    renderContent();
                    
                    setTimeout(() => {
                        state.isAnimating = false;
                    }, 400);
                }, 300);
            } else {
                setTimeout(() => {
                    state.isAnimating = false;
                }, 300);
            }
            
            // 保存设置
            saveSettings();
        }
        
        // 应用旋转效果 - 改为整体容器旋转
        function applyRotation() {
            // 移除所有旋转类
            appContainer.classList.remove('rotate-90', 'rotate-180', 'rotate-270');
            
            // 根据角度添加对应的类
            if (state.rotationAngle === 90) {
                appContainer.classList.add('rotate-90');
            } else if (state.rotationAngle === 180) {
                appContainer.classList.add('rotate-180');
            } else if (state.rotationAngle === 270) {
                appContainer.classList.add('rotate-270');
            }
        }
        
        // 更新旋转UI
        function updateRotationUI() {
            rotationValue.textContent = `${state.rotationAngle}°`;
        }
        
        // 重置到初始设置
        function resetToInitialSettings() {
            // 重置状态到初始值
            state.isPcMode = false;
            state.readingMode = 'single';
            state.isDarkMode = false;
            state.fontSize = 3;
            state.rotationAngle = 0; // 重置旋转角度
            
            // 更新UI
            updateUI();
            
            // 重新分页和渲染（如果有文本内容）
            if (state.textContent && !state.isAnimating) {
                state.isAnimating = true;
                paginateText();
                renderContent();
                setTimeout(() => { state.isAnimating = false; }, 400);
            }
            
            // 保存设置
            saveSettings();
            
            // 隐藏初始化确认面板
            hideInitialConfirmPanel();
            
            // 显示成功提示
            showToast('已重置到初始设置');
        }
        
        // 显示历史记录面板（从底部弹出）
        function showHistoryPanel() {
            if (isHistoryPanelOpen) return;
            
            // 先隐藏其他面板
            hideSettingsPanel();
            hideInitialConfirmPanel();
            
            // 确保不在删除确认模式
            historyPanel.classList.remove('delete-confirm-mode');
            
            // 渲染历史记录列表
            renderHistoryList();
            
            // 显示面板
            historyPanel.style.display = 'flex';
            // 强制重排以触发动画
            historyPanel.offsetHeight;
            historyPanel.classList.add('show');
            
            isHistoryPanelOpen = true;
        }
        
        // 隐藏历史记录面板
        function hideHistoryPanel() {
            if (!isHistoryPanelOpen) return;
            
            // 如果正在删除确认模式，先退出
            if (historyPanel.classList.contains('delete-confirm-mode')) {
                cancelDeleteConfirm();
                return;
            }
            
            // 隐藏面板
            historyPanel.classList.remove('show');
            
            setTimeout(() => {
                historyPanel.style.display = 'none';
                isHistoryPanelOpen = false;
                state.isManagingHistory = false;
                state.selectedHistoryItems = [];
                updateHistoryManagementUI();
            }, 500); // 动画时间
        }
        
        // 显示临时提示
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'touch-hint show';
            toast.textContent = message;
            toast.style.position = 'fixed';
            toast.style.bottom = '85px';
            toast.style.left = '50%';
            toast.style.transform = 'translateX(-50%)';
            toast.style.zIndex = '1000';
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 2000);
        }

        // 处理文件导入
        function handleFileImport(e) {
            const file = e.target.files[0];
            if (!file || !file.name.endsWith('.txt')) {
                alert('请选择TXT文件');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                state.textContent = event.target.result;
                state.fileName = file.name;
                state.currentPage = 1;
                
                fileNameDisplay.textContent = file.name;
                
                // 隐藏占位符，显示阅读器
                noTextPlaceholder.style.display = 'none';
                readerContainer.style.display = 'block';
                
                // 根据阅读模式显示/隐藏页导航
                if (state.readingMode === 'scroll') {
                    pageNavigation.style.display = 'none';
                } else {
                    pageNavigation.style.display = 'flex';
                }
                
                // 分页并渲染
                paginateText();
                renderContent();
                
                // 添加到历史记录
                addToHistory(file.name, event.target.result);
                
                // 保存文件内容到本地存储
                try {
                    localStorage.setItem(STORAGE_KEYS.LAST_FILE, state.textContent.substring(0, 10000));
                    localStorage.setItem(STORAGE_KEYS.LAST_FILENAME, state.fileName);
                    localStorage.setItem(STORAGE_KEYS.LAST_POSITION, JSON.stringify({
                        page: state.currentPage,
                        percent: 0
                    }));
                } catch (e) {
                    console.log('本地存储受限，无法保存文件');
                }
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        // 添加到历史记录
        function addToHistory(filename, content) {
            try {
                let history = JSON.parse(localStorage.getItem(STORAGE_KEYS.HISTORY)) || [];
                
                // 检查是否已存在相同文件名的记录
                const existingIndex = history.findIndex(item => item.filename === filename);
                
                const historyItem = {
                    id: Date.now().toString(),
                    filename: filename,
                    content: content, // 保存完整内容
                    fileSize: content.length,
                    addedDate: new Date().toISOString(),
                    lastOpened: new Date().toISOString()
                };
                
                if (existingIndex >= 0) {
                    // 更新现有记录
                    history[existingIndex] = {
                        ...history[existingIndex],
                        lastOpened: new Date().toISOString(),
                        content: content // 更新内容
                    };
                } else {
                    // 添加新记录
                    history.push(historyItem);
                }
                
                // 按文件名排序
                history.sort((a, b) => a.filename.localeCompare(b.filename));
                
                localStorage.setItem(STORAGE_KEYS.HISTORY, JSON.stringify(history));
            } catch (e) {
                console.log('无法保存到历史记录:', e);
                // 如果存储失败，尝试清理旧记录
                if (e.name === 'QuotaExceededError') {
                    alert('存储空间不足，将清理旧的历史记录');
                    // 保留最近10条记录
                    history = history.slice(-10);
                    try {
                        localStorage.setItem(STORAGE_KEYS.HISTORY, JSON.stringify(history));
                        addToHistory(filename, content); // 重试
                    } catch (e2) {
                        console.log('清理后仍然无法保存:', e2);
                    }
                }
            }
        }

        // 渲染历史记录列表
        function renderHistoryList() {
            try {
                const history = JSON.parse(localStorage.getItem(STORAGE_KEYS.HISTORY)) || [];
                
                if (history.length === 0) {
                    historyList.innerHTML = '<div class="history-empty">暂无历史记录</div>';
                    return;
                }
                
                historyList.innerHTML = '';
                
                history.forEach(item => {
                    const historyItem = document.createElement('div');
                    historyItem.className = `history-item ${state.selectedHistoryItems.includes(item.id) ? 'selected' : ''}`;
                    historyItem.dataset.id = item.id;
                    
                    const date = new Date(item.lastOpened);
                    const formattedDate = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                    
                    historyItem.innerHTML = `
                        <div class="history-checkbox ${state.selectedHistoryItems.includes(item.id) ? 'checked' : ''}"></div>
                        <div class="history-filename">${escapeHtml(item.filename)}</div>
                        <div class="history-date">${formattedDate}</div>
                    `;
                    
                    historyItem.addEventListener('click', (e) => {
                        if (state.isManagingHistory) {
                            // 管理模式下选择/取消选择
                            toggleHistoryItemSelection(item.id);
                            e.stopPropagation();
                        } else {
                            // 普通模式下打开历史记录
                            openHistoryItem(item);
                        }
                    });
                    
                    historyList.appendChild(historyItem);
                });
            } catch (e) {
                console.log('无法加载历史记录:', e);
                historyList.innerHTML = '<div class="history-empty">加载历史记录失败</div>';
            }
        }

        // 打开历史记录项
        function openHistoryItem(item) {
            // 直接从历史记录中加载内容
            state.textContent = item.content;
            state.fileName = item.filename;
            state.currentPage = 1;
            
            fileNameDisplay.textContent = item.filename;
            
            // 隐藏占位符，显示阅读器
            noTextPlaceholder.style.display = 'none';
            readerContainer.style.display = 'block';
            
            // 根据阅读模式显示/隐藏页导航
            if (state.readingMode === 'scroll') {
                pageNavigation.style.display = 'none';
            } else {
                pageNavigation.style.display = 'flex';
            }
            
            // 分页并渲染
            paginateText();
            renderContent();
            
            // 更新历史记录的最后打开时间
            updateHistoryLastOpened(item.id);
            
            // 隐藏历史记录面板
            hideHistoryPanel();
        }

        // 更新历史记录的最后打开时间
        function updateHistoryLastOpened(id) {
            try {
                let history = JSON.parse(localStorage.getItem(STORAGE_KEYS.HISTORY)) || [];
                const index = history.findIndex(item => item.id === id);
                
                if (index >= 0) {
                    history[index].lastOpened = new Date().toISOString();
                    localStorage.setItem(STORAGE_KEYS.HISTORY, JSON.stringify(history));
                }
            } catch (e) {
                console.log('无法更新历史记录:', e);
            }
        }

        // 切换历史记录管理模式
        function toggleManageHistory() {
            state.isManagingHistory = !state.isManagingHistory;
            state.selectedHistoryItems = [];
            updateHistoryManagementUI();
            renderHistoryList();
        }

        // 更新历史记录管理UI
        function updateHistoryManagementUI() {
            if (state.isManagingHistory) {
                manageHistoryBtn.textContent = '取消管理';
                deleteAllBtn.style.display = 'block';
                deleteSelectedBtn.style.display = 'block';
                deleteSelectedBtn.disabled = state.selectedHistoryItems.length === 0;
                
                // 显示所有复选框
                document.querySelectorAll('.history-checkbox').forEach(checkbox => {
                    checkbox.style.display = 'block';
                });
            } else {
                manageHistoryBtn.textContent = '管理';
                deleteAllBtn.style.display = 'none';
                deleteSelectedBtn.style.display = 'none';
                
                // 隐藏所有复选框
                document.querySelectorAll('.history-checkbox').forEach(checkbox => {
                    checkbox.style.display = 'none';
                });
            }
        }

        // 切换历史记录项选择
        function toggleHistoryItemSelection(id) {
            const index = state.selectedHistoryItems.indexOf(id);
            if (index >= 0) {
                state.selectedHistoryItems.splice(index, 1);
            } else {
                state.selectedHistoryItems.push(id);
            }
            
            updateHistoryManagementUI();
            renderHistoryList();
        }

        // 确认删除所有历史记录
        function confirmDeleteAll() {
            deleteConfirmTitle.textContent = '确认删除';
            deleteConfirmMessage.textContent = '确定要删除所有历史记录吗？此操作不可撤销。';
            deleteCallback = () => {
                deleteAllHistory();
            };
            
            // 切换到删除确认模式
            historyPanel.classList.add('delete-confirm-mode');
        }

        // 确认删除选中的历史记录
        function confirmDeleteSelected() {
            if (state.selectedHistoryItems.length === 0) return;
            
            deleteConfirmTitle.textContent = '确认删除';
            deleteConfirmMessage.textContent = `确定要删除选中的 ${state.selectedHistoryItems.length} 条历史记录吗？此操作不可撤销。`;
            deleteCallback = () => {
                deleteSelectedHistoryItems();
            };
            
            // 切换到删除确认模式
            historyPanel.classList.add('delete-confirm-mode');
        }

        // 取消删除确认
        function cancelDeleteConfirm() {
            // 退出删除确认模式
            historyPanel.classList.remove('delete-confirm-mode');
            deleteCallback = null;
        }

        // 执行删除操作
        function executeDelete() {
            if (deleteCallback) {
                deleteCallback();
                // 退出删除确认模式
                historyPanel.classList.remove('delete-confirm-mode');
                deleteCallback = null;
            }
        }

        // 删除所有历史记录
        function deleteAllHistory() {
            try {
                localStorage.removeItem(STORAGE_KEYS.HISTORY);
                state.selectedHistoryItems = [];
                renderHistoryList();
                updateHistoryManagementUI();
                showToast('已删除所有历史记录');
            } catch (e) {
                console.log('删除历史记录失败:', e);
                showToast('删除失败');
            }
        }

        // 删除选中的历史记录项
        function deleteSelectedHistoryItems() {
            try {
                let history = JSON.parse(localStorage.getItem(STORAGE_KEYS.HISTORY)) || [];
                const selectedCount = state.selectedHistoryItems.length;
                history = history.filter(item => !state.selectedHistoryItems.includes(item.id));
                
                localStorage.setItem(STORAGE_KEYS.HISTORY, JSON.stringify(history));
                state.selectedHistoryItems = [];
                renderHistoryList();
                updateHistoryManagementUI();
                showToast(`已删除 ${selectedCount} 条记录`);
            } catch (e) {
                console.log('删除历史记录失败:', e);
                showToast('删除失败');
            }
        }

        // 删除单个历史记录项
        function deleteHistoryItem(id) {
            try {
                let history = JSON.parse(localStorage.getItem(STORAGE_KEYS.HISTORY)) || [];
                history = history.filter(item => item.id !== id);
                
                localStorage.setItem(STORAGE_KEYS.HISTORY, JSON.stringify(history));
                renderHistoryList();
                
                // 如果正在管理，更新选中项
                const index = state.selectedHistoryItems.indexOf(id);
                if (index >= 0) {
                    state.selectedHistoryItems.splice(index, 1);
                    updateHistoryManagementUI();
                }
            } catch (e) {
                console.log('删除历史记录失败:', e);
            }
        }

        // 改进的智能分页算法 - 解决多分段问题
        function paginateText() {
            if (!state.textContent) return;
            
            // 如果是滚动模式，不需要分页
            if (state.readingMode === 'scroll') {
                state.pages = [state.textContent];
                state.totalPages = 1;
                return;
            }
            
            const pages = [];
            
            // 获取显示区域尺寸（考虑旋转）
            const contentAreaRect = contentArea.getBoundingClientRect();
            const fontSize = fontSizeMap[state.fontSize];
            
            // 创建临时元素测量文本
            const tempDiv = document.createElement('div');
            tempDiv.style.fontSize = `${fontSize}px`;
            tempDiv.style.lineHeight = '1.6';
            
            // 考虑旋转后的尺寸变化
            let containerWidth = contentAreaRect.width - 50; // 减去padding
            let containerHeight = contentAreaRect.height - 50; // 减去padding
            
            // 如果旋转了90度或270度，宽度和高度需要交换
            if (state.rotationAngle === 90 || state.rotationAngle === 270) {
                containerWidth = contentAreaRect.height - 50;
                containerHeight = contentAreaRect.width - 50;
            }
            
            tempDiv.style.width = `${containerWidth}px`;
            tempDiv.style.position = 'absolute';
            tempDiv.style.visibility = 'hidden';
            tempDiv.style.wordWrap = 'break-word';
            tempDiv.style.overflowWrap = 'break-word';
            tempDiv.style.wordBreak = 'break-word';
            tempDiv.style.padding = '25px'; // 模拟页面padding
            tempDiv.style.boxSizing = 'border-box';
            document.body.appendChild(tempDiv);
            
            // 将文本按换行符分割成段落，保留空行
            const paragraphs = state.textContent.split(/\n/);
            
            let currentPageText = '';
            let currentPageHeight = 0;
            const maxHeight = containerHeight;
            
            for (let i = 0; i < paragraphs.length; i++) {
                const paragraph = paragraphs[i];
                
                // 如果是空段落（换行符）
                if (paragraph === '') {
                    // 添加一个空行到当前页
                    const testText = currentPageText + (currentPageText ? '\n\n' : '');
                    tempDiv.innerHTML = testText.replace(/\n/g, '<br>');
                    const testHeight = tempDiv.offsetHeight;
                    
                    if (testHeight <= maxHeight) {
                        currentPageText = testText;
                        currentPageHeight = testHeight;
                    } else {
                        // 当前页已满，保存并开始新页
                        if (currentPageText) {
                            pages.push(currentPageText);
                        }
                        currentPageText = '';
                        currentPageHeight = 0;
                    }
                    continue;
                }
                
                // 测量段落单独的高度
                tempDiv.innerHTML = paragraph;
                const paragraphHeight = tempDiv.offsetHeight;
                
                // 如果段落本身超过一页高度，需要拆分段落
                if (paragraphHeight > maxHeight) {
                    // 如果当前页有内容，先保存当前页
                    if (currentPageText) {
                        pages.push(currentPageText);
                        currentPageText = '';
                        currentPageHeight = 0;
                    }
                    
                    // 拆分长段落
                    const splitParagraphs = splitLongParagraphForPage(paragraph, tempDiv, maxHeight);
                    
                    // 将拆分后的部分分别添加到页面
                    for (let j = 0; j < splitParagraphs.length; j++) {
                        const part = splitParagraphs[j];
                        
                        // 测量这部分的高度
                        tempDiv.innerHTML = part;
                        const partHeight = tempDiv.offsetHeight;
                        
                        if (partHeight <= maxHeight) {
                            // 可以单独成一页
                            pages.push(part);
                        } else {
                            // 这部分还是太长，需要进一步拆分
                            const subParts = splitLongParagraphForPage(part, tempDiv, maxHeight);
                            for (const subPart of subParts) {
                                pages.push(subPart);
                            }
                        }
                    }
                    
                    // 重置当前页
                    currentPageText = '';
                    currentPageHeight = 0;
                    continue;
                }
                
                // 测量将段落添加到当前页后的高度
                const separator = currentPageText && !currentPageText.endsWith('\n\n') ? '\n\n' : '';
                const testText = currentPageText + separator + paragraph;
                tempDiv.innerHTML = testText.replace(/\n/g, '<br>');
                const testHeight = tempDiv.offsetHeight;
                
                if (testHeight <= maxHeight) {
                    // 可以添加到当前页
                    currentPageText = testText;
                    currentPageHeight = testHeight;
                } else {
                    // 不能添加，先保存当前页
                    if (currentPageText) {
                        pages.push(currentPageText);
                    }
                    
                    // 开始新的一页，尝试将段落放入新页
                    tempDiv.innerHTML = paragraph;
                    if (tempDiv.offsetHeight <= maxHeight) {
                        currentPageText = paragraph;
                        currentPageHeight = tempDiv.offsetHeight;
                    } else {
                        // 段落还是放不下，需要拆分
                        const splitParagraphs = splitLongParagraphForPage(paragraph, tempDiv, maxHeight);
                        currentPageText = splitParagraphs[0];
                        pages.push(currentPageText);
                        
                        // 剩余部分
                        for (let j = 1; j < splitParagraphs.length; j++) {
                            pages.push(splitParagraphs[j]);
                        }
                        
                        currentPageText = '';
                        currentPageHeight = 0;
                    }
                }
            }
            
            // 添加最后一页
            if (currentPageText) {
                pages.push(currentPageText);
            }
            
            // 清理临时元素
            document.body.removeChild(tempDiv);
            
            state.pages = pages;
            
            // 双页模式：将两页视为一页
            if (state.readingMode === 'double') {
                // 计算双页模式下的总页数（两页为一组）
                state.totalPages = Math.ceil(pages.length / 2);
            } else {
                state.totalPages = pages.length;
            }
            
            state.currentPage = Math.min(state.currentPage, state.totalPages);
        }

        // 为分页拆分长段落
        function splitLongParagraphForPage(paragraph, tempDiv, maxHeight) {
            const parts = [];
            let remainingText = paragraph;
            
            while (remainingText.length > 0) {
                // 使用二分查找找到合适的拆分点
                let low = 0;
                let high = Math.min(remainingText.length, 500); // 限制每次检查的长度
                let lastFitIndex = 0;
                
                while (low <= high) {
                    const mid = Math.floor((low + high) / 2);
                    const testText = remainingText.substring(0, mid);
                    tempDiv.innerHTML = testText;
                    
                    if (tempDiv.offsetHeight <= maxHeight) {
                        lastFitIndex = mid;
                        low = mid + 1;
                    } else {
                        high = mid - 1;
                    }
                }
                
                // 如果没有找到合适的拆分点（第一个字符就超了），强制拆分
                if (lastFitIndex === 0) {
                    lastFitIndex = 1;
                }
                
                // 尝试在句子边界拆分
                let splitIndex = lastFitIndex;
                
                // 向后查找句子结束符
                for (let i = splitIndex; i < Math.min(remainingText.length, splitIndex + 20); i++) {
                    const char = remainingText.charAt(i);
                    if (char === '。' || char === '！' || char === '？' || char === '.' || char === '!' || char === '?' || char === ';' || char === '；') {
                        splitIndex = i + 1;
                        break;
                    }
                }
                
                // 如果没找到句子结束符，查找逗号或空格
                if (splitIndex === lastFitIndex) {
                    for (let i = splitIndex; i < Math.min(remainingText.length, splitIndex + 10); i++) {
                        const char = remainingText.charAt(i);
                        if (char === '，' || char === ',' || char === ' ' || char === '、') {
                            splitIndex = i + 1;
                            break;
                        }
                    }
                }
                
                // 确保不会拆分中文词汇（简单版本）
                if (splitIndex < remainingText.length) {
                    const nextChar = remainingText.charAt(splitIndex);
                    const prevChar = remainingText.charAt(splitIndex - 1);
                    
                    // 检查是否在中文词汇中间
                    const isChinese = /[\u4e00-\u9fff]/.test(nextChar) && /[\u4e00-\u9fff]/.test(prevChar);
                    if (isChinese && splitIndex > 1) {
                        splitIndex--; // 回退一个字符
                    }
                }
                
                // 提取部分文本
                const part = remainingText.substring(0, splitIndex).trim();
                if (part) {
                    parts.push(part);
                }
                
                // 更新剩余文本
                remainingText = remainingText.substring(splitIndex).trim();
                
                // 如果剩余文本很短，直接添加
                if (remainingText.length > 0 && remainingText.length < 50) {
                    tempDiv.innerHTML = remainingText;
                    if (tempDiv.offsetHeight <= maxHeight) {
                        parts.push(remainingText);
                        remainingText = '';
                    }
                }
            }
            
            return parts;
        }

        // 渲染内容
        function renderContent() {
            if (!state.textContent) return;
            
            // 清空阅读器容器
            readerContainer.innerHTML = '';
            
            // 根据阅读模式创建内容
            if (state.readingMode === 'scroll') {
                // 滚动模式 - 显示所有文本
                const scrollDiv = document.createElement('div');
                scrollDiv.className = 'scroll-mode-container';
                scrollDiv.style.fontSize = `${fontSizeMap[state.fontSize]}px`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'content';
                
                // 处理段落，保留空行
                const paragraphs = state.textContent.split(/\n/);
                paragraphs.forEach(paragraph => {
                    if (paragraph === '') {
                        // 空行
                        const p = document.createElement('p');
                        p.innerHTML = '&nbsp;'; // 空段落用空格占位
                        contentDiv.appendChild(p);
                    } else {
                        const p = document.createElement('p');
                        p.textContent = paragraph;
                        contentDiv.appendChild(p);
                    }
                });
                
                scrollDiv.appendChild(contentDiv);
                readerContainer.appendChild(scrollDiv);
                
                // 更新进度信息（百分比）
                updateScrollProgress();
                
            } else if (state.readingMode === 'single') {
                // 单页模式
                const pageContainer = document.createElement('div');
                pageContainer.className = 'page-container';
                
                // 创建所有页面，但只显示当前页
                for (let i = 0; i < state.pages.length; i++) {
                    const pageDiv = document.createElement('div');
                    pageDiv.className = `page ${i === state.currentPage - 1 ? 'active' : ''}`;
                    pageDiv.style.fontSize = `${fontSizeMap[state.fontSize]}px`;
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'page-content';
                    
                    // 处理页面文本，保留换行
                    const pageText = state.pages[i];
                    const paragraphs = pageText.split('\n');
                    
                    paragraphs.forEach(paragraph => {
                        if (paragraph === '') {
                            // 空行
                            const p = document.createElement('p');
                            p.innerHTML = '&nbsp;';
                            contentDiv.appendChild(p);
                        } else {
                            const p = document.createElement('p');
                            p.textContent = paragraph;
                            contentDiv.appendChild(p);
                        }
                    });
                    
                    pageDiv.appendChild(contentDiv);
                    pageContainer.appendChild(pageDiv);
                }
                
                readerContainer.appendChild(pageContainer);
                
            } else if (state.readingMode === 'double') {
                // 双页模式
                const doublePageContainer = document.createElement('div');
                doublePageContainer.className = 'double-page-container';
                
                // 计算双页模式的显示页码
                // 当前显示的第几组双页（从0开始）
                const doublePageIndex = state.currentPage - 1;
                
                // 对应的实际页码（两页为一组）
                const startPageIndex = doublePageIndex * 2;
                
                // 第一页
                const page1Div = document.createElement('div');
                page1Div.className = 'double-page';
                page1Div.style.fontSize = `${fontSizeMap[state.fontSize]}px`;
                
                const content1Div = document.createElement('div');
                content1Div.className = 'page-content';
                
                if (state.pages[startPageIndex]) {
                    const paragraphs1 = state.pages[startPageIndex].split('\n');
                    paragraphs1.forEach(paragraph => {
                        if (paragraph === '') {
                            const p = document.createElement('p');
                            p.innerHTML = '&nbsp;';
                            content1Div.appendChild(p);
                        } else {
                            const p = document.createElement('p');
                            p.textContent = paragraph;
                            content1Div.appendChild(p);
                        }
                    });
                }
                
                page1Div.appendChild(content1Div);
                doublePageContainer.appendChild(page1Div);
                
                // 分隔线
                const separator = document.createElement('div');
                separator.className = 'page-separator';
                doublePageContainer.appendChild(separator);
                
                // 第二页
                const page2Div = document.createElement('div');
                page2Div.className = 'double-page';
                page2Div.style.fontSize = `${fontSizeMap[state.fontSize]}px`;
                
                const content2Div = document.createElement('div');
                content2Div.className = 'page-content';
                
                if (state.pages[startPageIndex + 1]) {
                    const paragraphs2 = state.pages[startPageIndex + 1].split('\n');
                    paragraphs2.forEach(paragraph => {
                        if (paragraph === '') {
                            const p = document.createElement('p');
                            p.innerHTML = '&nbsp;';
                            content2Div.appendChild(p);
                        } else {
                            const p = document.createElement('p');
                            p.textContent = paragraph;
                            content2Div.appendChild(p);
                        }
                    });
                }
                
                page2Div.appendChild(content2Div);
                doublePageContainer.appendChild(page2Div);
                
                readerContainer.appendChild(doublePageContainer);
            }
            
            // 更新进度信息
            updateProgressInfo();
            
            // 更新页面指示器
            if (state.readingMode !== 'scroll') {
                currentPageSpan.textContent = state.currentPage;
                totalPagesSpan.textContent = state.totalPages;
                
                // 更新导航按钮状态
                prevPageBtn.disabled = state.currentPage === 1;
                nextPageBtn.disabled = state.currentPage === state.totalPages;
            }
        }

        // 更新滚动模式进度
        function updateScrollProgress() {
            if (state.readingMode !== 'scroll' || !state.textContent) return;
            
            const scrollContainer = readerContainer.querySelector('.scroll-mode-container');
            if (!scrollContainer) return;
            
            const scrollPercent = Math.round((scrollContainer.scrollTop / (scrollContainer.scrollHeight - scrollContainer.clientHeight)) * 100);
            progressInfo.textContent = `已阅读 ${scrollPercent}%`;
        }

        // 处理滚动事件
        function handleScroll() {
            if (state.readingMode === 'scroll') {
                updateScrollProgress();
            }
        }

        // 更新进度信息
        function updateProgressInfo() {
            if (!state.textContent) return;
            
            if (state.readingMode === 'scroll') {
                // 滚动模式显示百分比
                updateScrollProgress();
            } else {
                // 单页/双页模式显示页码
                const progress = Math.floor((state.currentPage / state.totalPages) * 100);
                const pageInfo = `第 ${state.currentPage} 页 / 共 ${state.totalPages} 页`;
                const progressInfoText = `${pageInfo} | 进度: ${progress}%`;
                
                progressInfo.textContent = progressInfoText;
            }
        }

        // 翻页函数 - 优化动画性能
        function goToPrevPage() {
            if (state.currentPage > 1) {
                state.currentPage--;
                renderContentWithAnimation('right'); // 向左翻页是右侧进入
            }
        }

        function goToNextPage() {
            if (state.currentPage < state.totalPages) {
                state.currentPage++;
                renderContentWithAnimation('left'); // 向右翻页是左侧进入
            }
        }

        // 优化后的带动画渲染 - 解决大量内容卡顿问题
        function renderContentWithAnimation(direction) {
            if (state.isAnimating) return;
            
            state.isAnimating = true;
            
            // 保存当前页面元素
            let currentPageElements = [];
            if (state.readingMode === 'single') {
                currentPageElements = Array.from(readerContainer.querySelectorAll('.page.active'));
            } else if (state.readingMode === 'double') {
                // 双页模式下整个容器都需要动画
                const currentContainer = readerContainer.querySelector('.double-page-container');
                if (currentContainer) currentPageElements = [currentContainer];
            }
            
            // 渲染新内容但不显示
            renderContent();
            
            // 获取新页面元素
            let newPageElements = [];
            if (state.readingMode === 'single') {
                newPageElements = Array.from(readerContainer.querySelectorAll('.page.active'));
            } else if (state.readingMode === 'double') {
                // 双页模式下整个容器都需要动画
                const newContainer = readerContainer.querySelector('.double-page-container');
                if (newContainer) newPageElements = [newContainer];
            }
            
            // 设置动画初始状态
            newPageElements.forEach(el => {
                el.style.transition = 'transform 0.4s cubic-bezier(0.23, 1, 0.32, 1), opacity 0.3s ease';
                el.style.willChange = 'transform, opacity';
                
                if (direction === 'left') {
                    el.style.transform = 'translateX(100%)';
                } else {
                    el.style.transform = 'translateX(-100%)';
                }
                el.style.opacity = '0';
            });
            
            // 触发动画
            requestAnimationFrame(() => {
                // 当前页离开
                currentPageElements.forEach(el => {
                    if (direction === 'left') {
                        el.style.transform = 'translateX(-100%)';
                    } else {
                        el.style.transform = 'translateX(100%)';
                    }
                    el.style.opacity = '0';
                });
                
                // 新页进入
                newPageElements.forEach(el => {
                    el.style.transform = 'translateX(0)';
                    el.style.opacity = '1';
                });
                
                // 动画完成后清理
                setTimeout(() => {
                    currentPageElements.forEach(el => {
                        el.style.transition = '';
                        el.style.willChange = '';
                    });
                    
                    newPageElements.forEach(el => {
                        el.style.transition = '';
                        el.style.willChange = '';
                    });
                    
                    state.isAnimating = false;
                }, 400);
            });
        }

        // 切换PC模式 - 仅调整UI，不重新分页
        function togglePcMode() {
            state.isPcMode = pcModeToggle.checked;
            appContainer.classList.toggle('pc-mode', state.isPcMode);
            
            // PC模式下移除强制横屏
            appContainer.classList.remove('force-landscape');
            
            // PC模式只是UI调整，不需要重新分页
            // 只需要重新渲染内容以适配新尺寸
            if (state.textContent && !state.isAnimating) {
                state.isAnimating = true;
                // 仅重新渲染，不重新分页
                renderContent();
                setTimeout(() => { state.isAnimating = false; }, 300);
            }
            
            // 保存设置
            saveSettings();
        }

        // 更改阅读模式
        function changeReadingMode() {
            const oldReadingMode = state.readingMode;
            state.readingMode = readingModeSelect.value;
            
            // 手机端双页模式强制横屏
            if (isMobileDevice() && state.readingMode === 'double' && !state.isPcMode) {
                appContainer.classList.add('force-landscape');
            } else if (!state.isPcMode) {
                appContainer.classList.remove('force-landscape');
            }
            
            // 根据阅读模式显示/隐藏页导航
            if (state.readingMode === 'scroll') {
                pageNavigation.style.display = 'none';
            } else {
                pageNavigation.style.display = 'flex';
            }
            
            // 如果从双页模式切换到其他模式，需要调整当前页码
            if (oldReadingMode === 'double' && state.readingMode !== 'double') {
                // 双页模式下每页对应实际两页，需要调整当前页码
                state.currentPage = Math.min(Math.ceil(state.currentPage * 2), state.pages.length);
            }
            
            // 重新分页和渲染
            if (state.textContent && !state.isAnimating) {
                state.isAnimating = true;
                paginateText();
                renderContent();
                setTimeout(() => { state.isAnimating = false; }, 400);
            }
            
            // 保存设置
            saveSettings();
        }

        // 切换暗色模式
        function toggleDarkMode() {
            state.isDarkMode = darkModeToggle.checked;
            document.body.classList.toggle('dark-mode', state.isDarkMode);
            
            // 保存设置
            saveSettings();
        }

        // 调整字体大小
        function adjustFontSize(delta) {
            const newSize = state.fontSize + delta;
            if (newSize >= 1 && newSize <= 10) {
                if (state.isAnimating) return;
                
                state.isAnimating = true;
                state.fontSize = newSize;
                fontSizeValue.textContent = state.fontSize;
                
                // 添加字体变化动画
                const contentElements = readerContainer.querySelectorAll('.page-content, .scroll-mode-container');
                contentElements.forEach(el => {
                    el.style.transition = 'font-size 0.4s ease';
                    el.style.fontSize = `${fontSizeMap[state.fontSize]}px`;
                });
                
                // 重新分页和渲染
                if (state.textContent) {
                    setTimeout(() => {
                        paginateText();
                        renderContent();
                        
                        // 动画完成后重置状态
                        setTimeout(() => {
                            state.isAnimating = false;
                        }, 400);
                    }, 400);
                } else {
                    setTimeout(() => {
                        state.isAnimating = false;
                    }, 400);
                }
                
                // 保存设置
                saveSettings();
            }
        }

        // 处理键盘事件
        function handleKeyDown(e) {
            // 忽略在输入框中的按键
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            
            // 如果是滚动模式，使用方向键滚动
            if (state.readingMode === 'scroll') {
                // 浏览器默认滚动行为
                return;
            }
            
            // 单页/双页模式使用方向键翻页
            switch(e.key) {
                case 'ArrowLeft':
                    goToPrevPage();
                    e.preventDefault();
                    break;
                case 'ArrowRight':
                    goToNextPage();
                    e.preventDefault();
                    break;
            }
        }

        // 更新UI
        function updateUI() {
            // 应用设置
            appContainer.classList.toggle('pc-mode', state.isPcMode);
            document.body.classList.toggle('dark-mode', state.isDarkMode);
            
            // 手机端PC模式不需要强制横屏
            if (state.isPcMode) {
                appContainer.classList.remove('force-landscape');
            }
            
            // 手机端双页模式强制横屏
            if (isMobileDevice() && state.readingMode === 'double' && !state.isPcMode) {
                appContainer.classList.add('force-landscape');
            }
            
            // 更新控件状态
            pcModeToggle.checked = state.isPcMode;
            readingModeSelect.value = state.readingMode;
            darkModeToggle.checked = state.isDarkMode;
            fontSizeValue.textContent = state.fontSize;
            
            // 更新旋转UI
            updateRotationUI();
            
            // 应用旋转
            applyRotation();
        }

        // 加载上次的文件
        function loadLastFile() {
            try {
                const lastFile = localStorage.getItem(STORAGE_KEYS.LAST_FILE);
                const lastFilename = localStorage.getItem(STORAGE_KEYS.LAST_FILENAME);
                const lastPosition = JSON.parse(localStorage.getItem(STORAGE_KEYS.LAST_POSITION) || '{}');
                
                if (lastFile && lastFilename) {
                    fileNameDisplay.textContent = `上次阅读: ${lastFilename}`;
                }
            } catch (e) {
                console.log('无法访问本地存储');
            }
        }

        // 保存设置到本地存储
        function saveSettings() {
            try {
                const settings = {
                    fontSize: state.fontSize,
                    isDarkMode: state.isDarkMode,
                    isPcMode: state.isPcMode,
                    readingMode: state.readingMode,
                    rotationAngle: state.rotationAngle // 保存旋转角度
                };
                localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(settings));
            } catch (e) {
                console.log('无法保存设置到本地存储');
            }
        }

        // 从本地存储加载设置
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem(STORAGE_KEYS.SETTINGS);
                if (savedSettings) {
                    const settings = JSON.parse(savedSettings);
                    
                    state.fontSize = settings.fontSize || 3;
                    state.isDarkMode = settings.isDarkMode || false;
                    state.isPcMode = settings.isPcMode || false;
                    state.readingMode = settings.readingMode || 'single';
                    state.rotationAngle = settings.rotationAngle || 0; // 加载旋转角度
                }
            } catch (e) {
                console.log('无法从本地存储加载设置');
            }
        }

        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 检测移动设备
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // HTML转义
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', initApp);
    </script>